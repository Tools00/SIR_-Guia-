<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modified SIR Model with Vaccination and Waning Immunity</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f7f9fc;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .main-content {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        .sidebar {
            flex: 0 0 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .results {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .results-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .results-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .results-label {
            font-weight: bold;
        }
        .results-value {
            text-align: right;
            color: #3498db;
            font-weight: bold;
        }
        .value-danger {
            color: #e74c3c;
        }
        .value-safe {
            color: #2ecc71;
        }
        .charts-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chart-container {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        .chart-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .chart-tab {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
        }
        .chart-tab.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }
        .chart-panel {
            display: none;
        }
        .chart-panel.active {
            display: block;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-weight: bold;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .control-group label .info-icon {
            color: #3498db;
            cursor: help;
            position: relative;
        }
        .control-group label .info-tooltip {
            visibility: hidden;
            width: 200px;
            background-color: #34495e;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 12px;
        }
        .control-group label .info-icon:hover .info-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .control-slider {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-slider input[type="range"] {
            flex: 1;
        }
        .control-slider output {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
            color: #3498db;
        }
        .control-range {
            font-size: 12px;
            color: #7f8c8d;
        }
        button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .explanation {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .tooltip-container {
            position: absolute;
            background-color: rgba(45, 52, 54, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .tooltip-value {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        .tooltip-label {
            margin-right: 10px;
            font-weight: bold;
        }
        .tooltip-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
            .sidebar {
                flex: initial;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Modified SIR Model with Vaccination and Several Levels of Immunity</h1>
            <p>Simulation of epidemic dynamics with waning immunity across multiple levels based on the paper by Prof F. Guias </p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
               <div class="controls">
    <h3>Model Parameters</h3>
    <div class="button-group">
        <button id="reset-btn">Reset</button>
        <button id="start-btn">Run Simulation</button>
    </div>
    
    <h4>Disease Parameters</h4>
                    <div class="control-group">
                        <label for="R0">
                            Basic Reproduction Number (R₀)
                            <span class="info-icon">ⓘ
                                <span class="info-tooltip">Average number of secondary infections from one infectious individual in a fully susceptible population</span>
                            </span>
                        </label>
                        <div class="control-slider">
                            <input type="range" id="R0" min="2" max="8" step="0.1" value="4">
                            <output for="R0" id="R0-value">4.0</output>
                        </div>
                        <div class="control-range">Range: 2.0 (mild) to 8.0 (very contagious)</div>
                    </div>
                    
                    <div class="control-group">
                        <label for="alpha">
                            Immunity Decay Rate (α)
                            <span class="info-icon">ⓘ
                                <span class="info-tooltip">Rate at which immunity wanes over time (higher values = faster decay)</span>
                            </span>
                        </label>
                        <div class="control-slider">
                            <input type="range" id="alpha" min="0.008" max="0.02" step="0.001" value="0.014">
                            <output for="alpha" id="alpha-value">0.014</output>
                        </div>
                        <div class="control-range">Range: 0.008 (slow decay) to 0.02 (fast decay)</div>
                    </div>
                    
                    <div class="control-group">
                        <label for="recovery-rate">
                            Recovery Rate (α)
                            <span class="info-icon">ⓘ
                                <span class="info-tooltip">Rate at which infected individuals recover (1/infectious period)</span>
                            </span>
                        </label>
                        <div class="control-slider">
                            <input type="range" id="recovery-rate" min="0.05" max="0.5" step="0.01" value="0.25">
                            <output for="recovery-rate" id="recovery-rate-value">0.25</output>
                        </div>
                        <div class="control-range">Range: 0.05 (20 days) to 0.5 (2 days)</div>
                        <div id="infectious-period">Infectious period: 4.0 days</div>
                    </div>
                    
                    <div class="control-group">
                        <label for="initial-infected">
                            Initial Infected Population
                            <span class="info-icon">ⓘ
                                <span class="info-tooltip">Percentage of population initially infected</span>
                            </span>
                        </label>
                        <div class="control-slider">
                            <input type="range" id="initial-infected" min="0.01" max="1" step="0.01" value="0.01">
                            <output for="initial-infected" id="initial-infected-value">0.01%</output>
                        </div>
                        <div class="control-range">Range: 0.01% to 1%</div>
                    </div>
                    
                    <h4>Vaccination Parameters</h4>
                    <div class="control-group">
                        <label for="vacc-rate">
                            Vaccination Rate (γ₀)
                            <span class="info-icon">ⓘ
                                <span class="info-tooltip">Daily vaccination rate as a fraction of population</span>
                            </span>
                        </label>
                        <div class="control-slider">
                            <input type="range" id="vacc-rate" min="0.001" max="0.02" step="0.001" value="0.005">
                            <output for="vacc-rate" id="vacc-rate-value">0.005</output>
                        </div>
                        <div class="control-range">Range: 0.001 (low) to 0.02 (high)</div>
                        <div id="daily-vaccinations">Population vaccinated daily: 0.5%</div>
                    </div>
                    
                    <div class="control-group">
                        <label for="fact">Vaccination Strategy</label>
                        <select id="fact">
                            <option value="0">Only at minimum immunity level (0)</option>
                            <option value="1" selected>All levels up to k₀ (R_k ≥ 1)</option>
                        </select>
                    </div>
                    
                    <h4>Model Structure</h4>
                    <div class="control-group">
                        <label for="immunity-levels">
                            Maximum Immunity Levels (m)
                            <span class="info-icon">ⓘ
                                <span class="info-tooltip">Number of discrete immunity levels in the model</span>
                            </span>
                        </label>
                        <div class="control-slider">
                            <input type="range" id="immunity-levels" min="100" max="365" step="5" value="365">
                            <output for="immunity-levels" id="immunity-levels-value">365</output>
                        </div>
                        <div class="control-range">Range: 100 to 365 levels</div>
                    </div>
                    
                    <div class="control-group">
                        <label for="simulation-duration">
                            Simulation Duration (days)
                            <span class="info-icon">ⓘ
                                <span class="info-tooltip">Total time period to simulate</span>
                            </span>
                        </label>
                        <div class="control-slider">
                            <input type="range" id="simulation-duration" min="500" max="3000" step="100" value="1500">
                            <output for="simulation-duration" id="simulation-duration-value">1500</output>
                        </div>
                        <div class="control-range">Range: 500 to 3000 days</div>
                    </div>
                    
                    
                </div>
                
                <div class="results">
                    <div class="results-header">Key Results</div>
                    <div class="results-item">
                        <div class="results-label">Immunity Threshold (k₀):</div>
                        <div class="results-value" id="k0-value">-</div>
                    </div>
                    <div class="results-item">
                        <div class="results-label">Critical Vaccination Rate:</div>
                        <div class="results-value" id="critical-vacc-rate">-</div>
                    </div>
                    <div class="results-item">
                        <div class="results-label">Current Vaccination Rate:</div>
                        <div class="results-value" id="current-vacc-rate">-</div>
                    </div>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-tabs">
                    <div class="chart-tab active" data-tab="population">Population Dynamics</div>
                    <div class="chart-tab" data-tab="infected">Infection Detail</div>
                    <div class="chart-tab" data-tab="r-values">R Values</div>
                </div>
                
                <div class="chart-panel active" id="population-panel">
                    <div class="chart-container">
                        <div id="tooltip-main" class="tooltip-container"></div>
                        <canvas id="main-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-panel" id="infected-panel">
                    <div class="chart-container">
                        <div id="tooltip-infected" class="tooltip-container"></div>
                        <canvas id="infected-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-panel" id="r-values-panel">
                    <div class="chart-container">
                        <div id="tooltip-r-values" class="tooltip-container"></div>
                        <canvas id="r-values-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div id="tooltip-aggregate" class="tooltip-container"></div>
                    <canvas id="aggregate-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="explanation">
            <h3>Model Explanation</h3>
            <p>This interactive simulation implements the modified SIR model with waning immunity and vaccination as described in the paper by Flavius Guiaș. The model extends the standard SIR approach with:</p>
            <ul>
                <li><strong>Multiple immunity levels:</strong> Immunity wanes gradually over time, with level 0 being no immunity and level m being maximum immunity.</li>
                <li><strong>Exponential decay of immunity:</strong> R_k = R₀·e^(-α·k) where R_k is the reproduction number at immunity level k.</li>
                <li><strong>Targeted vaccination:</strong> Vaccination can be applied to specific immunity levels based on strategy.</li>
                <li><strong>Critical vaccination rate:</strong> The minimum vaccination rate needed to eventually eradicate the epidemic.</li>
            </ul>
            <p>The simulation shows long-term epidemic dynamics including possible recurring waves and endemic states.</p>
        </div>
    </div>

    <script>
        // Model parameters
        let m = 365; // Number of immunity levels
        let R0 = 4.0; // Basic reproduction number
        let alpha = 0.014; // Immunity decay coefficient
        let vaccRate = 0.005; // Vaccination rate
        let fact = 1; // Vaccination strategy
        let recoveryRate = 0.25; // Recovery rate
        let T_inf = 1/recoveryRate; // Infectious period in days
        let initialInfected = 0.01; // Initial infected population percentage
        let simulationDuration = 1500; // Simulation duration in days
        
        // Arrays to store model state and parameters
        let y = []; // State vector: y[0..m-1] = immunity levels, y[m] = max immunity, y[m+1] = infected
        let R = []; // Reproduction numbers for each immunity level
        let b = []; // Transmission rates
        let g = []; // Vaccination rates
        let e = []; // Immunity waning rates
        let k0 = 0; // Critical immunity level
        
        // Chart objects
        let mainChart, infectedChart, aggregateChart, rValuesChart;
        let simulationRunning = false;
        
        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Set up event listeners
            document.getElementById('R0').addEventListener('input', updateR0Value);
            document.getElementById('alpha').addEventListener('input', updateAlphaValue);
            document.getElementById('vacc-rate').addEventListener('input', updateVaccRateValue);
            document.getElementById('recovery-rate').addEventListener('input', updateRecoveryRate);
            document.getElementById('initial-infected').addEventListener('input', updateInitialInfected);
            document.getElementById('immunity-levels').addEventListener('input', updateImmunityLevels);
            document.getElementById('simulation-duration').addEventListener('input', updateSimulationDuration);
            document.getElementById('start-btn').addEventListener('click', startSimulation);
            document.getElementById('reset-btn').addEventListener('click', resetSimulation);
            
            // Set up tab switching
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.chart-panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
                });
            });
            
            // Initialize charts
            initializeCharts();
            
            // Initialize model parameters
            initializeModel();
            
            // Initial calculation and display of k0 and critical vaccination rate
            calculateAndDisplayResults();
        });
        
        function updateR0Value() {
            R0 = parseFloat(this.value);
            document.getElementById('R0-value').textContent = R0.toFixed(1);
            calculateAndDisplayResults();
        }
        
        function updateAlphaValue() {
            alpha = parseFloat(this.value);
            document.getElementById('alpha-value').textContent = alpha.toFixed(3);
            calculateAndDisplayResults();
        }
        
        function updateVaccRateValue() {
            vaccRate = parseFloat(this.value);
            document.getElementById('vacc-rate-value').textContent = vaccRate.toFixed(3);
            document.getElementById('daily-vaccinations').textContent = `Population vaccinated daily: ${(vaccRate * 100).toFixed(2)}%`;
            calculateAndDisplayResults();
        }
        
        function updateRecoveryRate() {
            recoveryRate = parseFloat(this.value);
            document.getElementById('recovery-rate-value').textContent = recoveryRate.toFixed(2);
            T_inf = 1/recoveryRate;
            document.getElementById('infectious-period').textContent = `Infectious period: ${T_inf.toFixed(1)} days`;
            calculateAndDisplayResults();
        }
        
        function updateInitialInfected() {
            initialInfected = parseFloat(this.value);
            document.getElementById('initial-infected-value').textContent = `${initialInfected.toFixed(2)}%`;
        }
        
        function updateImmunityLevels() {
            m = parseInt(this.value);
            document.getElementById('immunity-levels-value').textContent = m;
            calculateAndDisplayResults();
        }
        
        function updateSimulationDuration() {
            simulationDuration = parseInt(this.value);
            document.getElementById('simulation-duration-value').textContent = simulationDuration;
        }
        
        function initializeModel() {
            // Initialize state vector
            y = new Array(m+2).fill(0);
            y[0] = 1 - initialInfected/100; // Population at immunity level 0
            y[m+1] = initialInfected/100; // Initial infected population
            
            // Initialize parameters
            calculateModelParameters();
        }
        
        function calculateModelParameters() {
            // Calculate k0 (critical immunity level where R_k < 1)
            k0 = Math.floor(Math.log(R0) / alpha);
            if (k0 > m) k0 = m;
            
            // Calculate R_k values for each immunity level
            R = new Array(m+1).fill(0);
            for (let k = 0; k <= m; k++) {
                R[k] = R0 * Math.exp(-alpha * k);
            }
            
            // Calculate transmission rates b_k
            b = new Array(m+1).fill(0);
            for (let k = 0; k <= m; k++) {
                b[k] = recoveryRate * R[k];
            }
            
            // Initialize immunity waning rates (all 1 except e[0] = 0)
            e = new Array(m+1).fill(1);
            e[0] = 0; // No further decay at level 0
            
            // Initialize vaccination rates based on strategy
            g = new Array(m+1).fill(0);
            if (fact === 0) {
                // Vaccination only at level 0
                g[0] = vaccRate;
            } else {
                // Vaccination at levels 0 to k0
                for (let k = 0; k <= k0; k++) {
                    g[k] = vaccRate;
                }
            }
        }
        
        function calculateCriticalVaccinationRate() {
            // Calculate the critical vaccination rate based on Equation (5) in the paper
            // Λ(a, R0, γ0) = (R0 - 1)/γ0 + Σ(k=1 to k0) (R0*e^(-a*k) - 1)*(1+γ0)^(k-1) +
            //                 Σ(k=k0+1 to m) (R0*e^(-a*k) - 1)*(1+γ0)^k0 < 0
            
            // We'll use bisection method to find γ0 where Λ(a, R0, γ0) = 0
            const epsilon = 1e-6;
            let left = 0.0001;  // Lower bound for vaccination rate
            let right = 0.5;    // Upper bound
            
            // Function to calculate Λ for a given vaccination rate
            const calculateLambda = (gamma) => {
                let sum1 = (R0 - 1) / gamma;
                
                let sum2 = 0;
                for (let k = 1; k <= k0; k++) {
                    sum2 += (R0 * Math.exp(-alpha * k) - 1) * Math.pow(1 + gamma, k - 1);
                }
                
                let sum3 = 0;
                for (let k = k0 + 1; k <= m; k++) {
                    sum3 += (R0 * Math.exp(-alpha * k) - 1) * Math.pow(1 + gamma, k0);
                }
                
                return sum1 + sum2 + sum3;
            };
            
            // Bisection method
            let mid, lambdaMid;
            for (let i = 0; i < 50; i++) {  // Max 50 iterations
                mid = (left + right) / 2;
                lambdaMid = calculateLambda(mid);
                
                if (Math.abs(lambdaMid) < epsilon || (right - left) / 2 < epsilon) {
                    break;
                }
                
                if (lambdaMid > 0) {
                    left = mid;
                } else {
                    right = mid;
                }
            }
            
            return mid;
        }
        
        function calculateAndDisplayResults() {
            // Calculate k0 and critical vaccination rate ; Berechne k0 und kritische Impfrate
            calculateModelParameters();
            const criticalVaccRate = calculateCriticalVaccinationRate();
            
            // Update the results display ; Aktualisiere die Ergebnisanzeige
            document.getElementById('k0-value').textContent = k0;
            document.getElementById('critical-vacc-rate').textContent = criticalVaccRate.toFixed(5);
            document.getElementById('current-vacc-rate').textContent = vaccRate.toFixed(5);
            
            // Highlight if current rate is below critical rate ; Hebe hervor, wenn aktuelle Rate unter kritischer Rate liegt
            const currentRateElement = document.getElementById('current-vacc-rate');
            if (vaccRate < criticalVaccRate) {
                currentRateElement.classList.add('value-danger');
                currentRateElement.classList.remove('value-safe');
            } else {
                currentRateElement.classList.add('value-safe');
                currentRateElement.classList.remove('value-danger');
            }
            
            // Update the R values chart ; Aktualisiere das R-Werte-Diagramm
            updateRValuesChart();
        }
        
        function initializeCharts() {
            // Create chart for R values
            const rValuesCtx = document.getElementById('r-values-chart').getContext('2d');
            rValuesChart = new Chart(rValuesCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'R values',
                            data: [],
                            borderColor: 'rgba(52, 152, 219, 1)',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'R = 1 threshold',
                            data: [],
                            borderColor: 'rgba(231, 76, 60, 1)',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.1
                        },
                        {
                            label: 'k₀ threshold',
                            data: [],
                            borderColor: 'rgba(46, 204, 113, 1)',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `R Values by Immunity Level (R₀=${R0}, a=${alpha})`
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Immunity Level (k)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Reproduction Number'
                            },
                            min: 0
                        }
                    }
                }
            });
            
            // Create main chart (population distribution)
            const mainCtx = document.getElementById('main-chart').getContext('2d');
            mainChart = new Chart(mainCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Level 0 (Susceptible)',
                            data: [],
                            borderColor: 'rgba(52, 152, 219, 1)',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: 'Level Max (Highest Immunity)',
                            data: [],
                            borderColor: 'rgba(46, 204, 113, 1)',
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: 'Infected',
                            data: [],
                            borderColor: 'rgba(231, 76, 60, 1)',
                            backgroundColor: 'rgba(231, 76, 60, 0.2)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Population Distribution Over Time'
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Population Fraction'
                            },
                            min: 0
                        }
                    }
                }
            });
            
            // Create infected chart (zoomed view)
            const infectedCtx = document.getElementById('infected-chart').getContext('2d');
            infectedChart = new Chart(infectedCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Infected',
                        data: [],
                        borderColor: 'rgba(231, 76, 60, 1)',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Infected Population (Zoomed)'
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Population Fraction'
                            },
                            min: 0,
                            max: 0.05 // Zoomed view for better visibility of smaller infection waves
                        }
                    }
                }
            });
            
            // Create aggregate chart
            const aggregateCtx = document.getElementById('aggregate-chart').getContext('2d');
            aggregateChart = new Chart(aggregateCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Levels 0 to k₀',
                            data: [],
                            borderColor: 'rgba(52, 152, 219, 1)',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: 'Levels k₀+1 to m',
                            data: [],
                            borderColor: 'rgba(46, 204, 113, 1)',
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: 'Infected',
                            data: [],
                            borderColor: 'rgba(231, 76, 60, 1)',
                            backgroundColor: 'rgba(231, 76, 60, 0.2)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Aggregated Population Groups'
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Population Fraction'
                            },
                            min: 0
                        }
                    }
                }
            });
            
            // Set up custom tooltips for all charts
            setupCustomTooltips();
            
            // Initial update of R values chart
            updateRValuesChart();
        }
        
        function setupCustomTooltips() {
            // Setup tooltips for main chart
            const mainTooltip = document.getElementById('tooltip-main');
            const mainChartElement = document.getElementById('main-chart');
            setupTooltipForChart(mainChart, mainTooltip, mainChartElement);
            
            // Setup tooltips for infected chart
            const infectedTooltip = document.getElementById('tooltip-infected');
            const infectedChartElement = document.getElementById('infected-chart');
            setupTooltipForChart(infectedChart, infectedTooltip, infectedChartElement);
            
            // Setup tooltips for aggregate chart
            const aggregateTooltip = document.getElementById('tooltip-aggregate');
            const aggregateChartElement = document.getElementById('aggregate-chart');
            setupTooltipForChart(aggregateChart, aggregateTooltip, aggregateChartElement);
            
            // Setup tooltips for R values chart
            const rValuesTooltip = document.getElementById('tooltip-r-values');
            const rValuesChartElement = document.getElementById('r-values-chart');
            setupTooltipForChart(rValuesChart, rValuesTooltip, rValuesChartElement);
        }
        
        function setupTooltipForChart(chart, tooltipElement, chartElement) {
    // Show tooltip on mousemove
    chartElement.addEventListener('mousemove', (event) => {
        const rect = chartElement.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        // Get the x value from chart
        const xValue = chart.scales.x.getValueForPixel(x);
        if (xValue < 0 || xValue >= chart.data.labels.length) {
            tooltipElement.style.display = 'none';
            return;
        }
        
        const roundedXValue = Math.round(xValue);
        
        // Format tooltip content - special format for R-values chart
        let html = '';
        
        // Check if this is the R-values chart
        if (chart === rValuesChart) {
            const immunityLevel = chart.data.labels[roundedXValue];
            const rValue = chart.data.datasets[0].data[roundedXValue];
            const isK0 = immunityLevel === k0;
            
            html = `
                <div class="tooltip-title">Immunity Level: ${immunityLevel}</div>
                <div class="tooltip-value">
                    <span class="tooltip-color" style="background-color: ${chart.data.datasets[0].borderColor}"></span>
                    <span class="tooltip-label">R Value:</span>
                    <span>${rValue.toFixed(4)}</span>
                </div>
            `;
            
            if (isK0) {
                html += `<div class="tooltip-value" style="color: #2ecc71; font-weight: bold;">k₀ Threshold</div>`;
            }
            
            if (rValue < 1) {
                html += `<div class="tooltip-value" style="color: #2ecc71;">R < 1 (Disease Control)</div>`;
            } else {
                html += `<div class="tooltip-value" style="color: #e74c3c;">R > 1 (Disease Spread)</div>`;
            }
        } else {
            // Original tooltip format for other charts
            html = `<div class="tooltip-title">${chart.data.labels[roundedXValue]}</div>`;
            
            chart.data.datasets.forEach((dataset, i) => {
                if (dataset.data.length > 0) {
                    const value = dataset.data[roundedXValue];
                    html += `
                        <div class="tooltip-value">
                            <span class="tooltip-color" style="background-color: ${dataset.borderColor}"></span>
                            <span class="tooltip-label">${dataset.label}:</span>
                            <span>${typeof value === 'number' ? value.toFixed(4) : value}</span>
                        </div>
                    `;
                }
            });
        }
        
        tooltipElement.innerHTML = html;
        tooltipElement.style.display = 'block';
        
        // Position tooltip
        tooltipElement.style.left = (x + 10) + 'px';
        tooltipElement.style.top = (y + 10) + 'px';
        
        // Ensure tooltip stays within chart container
        const tooltipRect = tooltipElement.getBoundingClientRect();
        if (tooltipRect.right > rect.right) {
            tooltipElement.style.left = (x - tooltipRect.width - 10) + 'px';
        }
        if (tooltipRect.bottom > rect.bottom) {
            tooltipElement.style.top = (y - tooltipRect.height - 10) + 'px';
        }
    });
    
    // Hide tooltip when mouse leaves chart
    chartElement.addEventListener('mouseleave', () => {
        tooltipElement.style.display = 'none';
    });
}
        function updateRValuesChart() {
            // Update the R values chart based on current parameters
            const labels = Array.from({length: m + 1}, (_, i) => i);
            const rValues = labels.map(k => R0 * Math.exp(-alpha * k));
            
            // Create threshold line for R = 1
            const rThreshold = labels.map(() => 1);
            
            // Create threshold line for k0
            const k0Threshold = labels.map(k => {
                if (k === k0) return Math.max(...rValues);
                if (k === 0) return Math.max(...rValues);
                return null;
            });
            
            // Update chart data
            rValuesChart.data.labels = labels;
            rValuesChart.data.datasets[0].data = rValues;
            rValuesChart.data.datasets[1].data = rThreshold;
            rValuesChart.data.datasets[2].data = k0Threshold;
            
            // Update chart title
            rValuesChart.options.plugins.title.text = `R Values by Immunity Level (R₀=${R0}, a=${alpha.toFixed(3)})`;
            
            // Refresh chart
            rValuesChart.update();
        }
        
        // Main ODE function that calculates derivatives
        function odeImmF(t, y) {
            const dydt = new Array(m+2).fill(0);
            
            // Equations for immunity levels 0 to m-1
            for (let k = 0; k < m; k++) {
                dydt[k] = -b[k] * y[m+1] * y[k] - g[k] * y[k] - e[k] * y[k] + e[k+1] * y[k+1];
            }
            
            // Equation for maximum immunity level (m)
            dydt[m] = recoveryRate * y[m+1] - e[m] * y[m] - b[m] * y[m+1] * y[m];
            
            // Add vaccination terms
            for (let k = 0; k < m; k++) {
                dydt[m] += g[k] * y[k];
            }
            
            // Equation for infected
            dydt[m+1] = -recoveryRate * y[m+1];
            for (let k = 0; k <= m; k++) {
                dydt[m+1] += b[k] * y[m+1] * y[k];
            }
            
            return dydt;
        }
        
        // 4th order Runge-Kutta method for ODE solving
        function rungeKutta4(f, t, y, h) {
            const k1 = f(t, y);
            
            const yTemp = y.map((yi, i) => yi + h * k1[i] / 2);
            const k2 = f(t + h/2, yTemp);
            
            const yTemp2 = y.map((yi, i) => yi + h * k2[i] / 2);
            const k3 = f(t + h/2, yTemp2);
            
            const yTemp3 = y.map((yi, i) => yi + h * k3[i]);
            const k4 = f(t + h, yTemp3);
            
            const nextY = y.map((yi, i) => {
                return yi + h * (k1[i] + 2*k2[i] + 2*k3[i] + k4[i]) / 6;
            });
            
            return nextY;
        }
        
        function startSimulation() {
            if (simulationRunning) return;
            
            // Set simulation running flag
            simulationRunning = true;
            
            // Disable UI controls during simulation
            document.getElementById('start-btn').disabled = true;
            
            // Reset model and charts
            resetSimulation(false);
            
            // Update model parameters based on current UI values
            R0 = parseFloat(document.getElementById('R0').value);
            alpha = parseFloat(document.getElementById('alpha').value);
            vaccRate = parseFloat(document.getElementById('vacc-rate').value);
            recoveryRate = parseFloat(document.getElementById('recovery-rate').value);
            T_inf = 1/recoveryRate;
            initialInfected = parseFloat(document.getElementById('initial-infected').value);
            m = parseInt(document.getElementById('immunity-levels').value);
            simulationDuration = parseInt(document.getElementById('simulation-duration').value);
            fact = parseInt(document.getElementById('fact').value);
            
            // Initialize model state
            initializeModel();
            
            // Calculate and display results
            calculateAndDisplayResults();
            
            // Simulation parameters
            const days = simulationDuration; // Total days to simulate
            const dt = 0.2; // Time step (days)
            const stepsPerDay = 1/dt;
            const samplingInterval = 1; // Days between data points for visualization
            
            // Arrays to store results
            const timePoints = [];
            const level0Data = [];
            const levelMaxData = [];
            const infectedData = [];
            const lowLevelsData = [];
            const highLevelsData = [];
            
            // Current state
            let currentY = [...y];
            let t = 0;
            
            // Use requestAnimationFrame for smoother UI updates
            const simulationStep = () => {
                // Run simulation for one day
                for (let step = 0; step < stepsPerDay; step++) {
                    currentY = rungeKutta4(odeImmF, t, currentY, dt);
                    t += dt;
                }
                
                // Store results every samplingInterval days
                if (Math.round(t) % samplingInterval === 0) {
                    const dayNumber = Math.round(t);
                    timePoints.push(dayNumber);
                    
                    // Store individual compartment data
                    level0Data.push(currentY[0]);
                    levelMaxData.push(currentY[m]);
                    infectedData.push(currentY[m+1]);
                    
                    // Calculate aggregated levels
                    let lowLevelsSum = 0;
                    for (let k = 0; k <= k0; k++) {
                        lowLevelsSum += currentY[k];
                    }
                    
                    let highLevelsSum = 0;
                    for (let k = k0+1; k <= m; k++) {
                        highLevelsSum += currentY[k];
                    }
                    
                    lowLevelsData.push(lowLevelsSum);
                    highLevelsData.push(highLevelsSum);
                    
                    // Update charts every 10 days or at the end
                    if (dayNumber % 10 === 0 || dayNumber >= days) {
                        updateCharts(timePoints, level0Data, levelMaxData, infectedData, lowLevelsData, highLevelsData);
                    }
                }
                
                // Continue simulation if not finished
                if (t < days) {
                    requestAnimationFrame(simulationStep);
                } else {
                    // Enable UI controls after simulation is complete
                    document.getElementById('start-btn').disabled = false;
                    simulationRunning = false;
                    
                    // Final update of charts
                    updateCharts(timePoints, level0Data, levelMaxData, infectedData, lowLevelsData, highLevelsData);
                }
            };
            
            // Start the simulation
            requestAnimationFrame(simulationStep);
        }
        
        function updateCharts(timePoints, level0Data, levelMaxData, infectedData, lowLevelsData, highLevelsData) {
            // Update main chart
            mainChart.data.labels = timePoints;
            mainChart.data.datasets[0].data = level0Data;
            mainChart.data.datasets[1].data = levelMaxData;
            mainChart.data.datasets[2].data = infectedData;
            mainChart.update();
            
            // Update infected chart
            infectedChart.data.labels = timePoints;
            infectedChart.data.datasets[0].data = infectedData;
            infectedChart.update();
            
            // Update aggregate chart
            aggregateChart.data.labels = timePoints;
            aggregateChart.data.datasets[0].data = lowLevelsData;
            aggregateChart.data.datasets[1].data = highLevelsData;
            aggregateChart.data.datasets[2].data = infectedData;
            aggregateChart.update();
        }
        
        function resetSimulation(resetUI = true) {
            // Clear charts
            mainChart.data.labels = [];
            mainChart.data.datasets.forEach(dataset => {
                dataset.data = [];
            });
            mainChart.update();
            
            infectedChart.data.labels = [];
            infectedChart.data.datasets[0].data = [];
            infectedChart.update();
            
            aggregateChart.data.labels = [];
            aggregateChart.data.datasets.forEach(dataset => {
                dataset.data = [];
            });
            aggregateChart.update();
            
            // Reset model state
            initializeModel();
            
            // Reset UI if requested
            if (resetUI) {
                document.getElementById('R0').value = 4.0;
                document.getElementById('R0-value').textContent = "4.0";
                R0 = 4.0;
                
                document.getElementById('alpha').value = 0.014;
                document.getElementById('alpha-value').textContent = "0.014";
                alpha = 0.014;
                
                document.getElementById('vacc-rate').value = 0.005;
                document.getElementById('vacc-rate-value').textContent = "0.005";
                document.getElementById('daily-vaccinations').textContent = "Population vaccinated daily: 0.5%";
                vaccRate = 0.005;
                
                document.getElementById('recovery-rate').value = 0.25;
                document.getElementById('recovery-rate-value').textContent = "0.25";
                document.getElementById('infectious-period').textContent = "Infectious period: 4.0 days";
                recoveryRate = 0.25;
                T_inf = 4.0;
                
                document.getElementById('initial-infected').value = 0.01;
                document.getElementById('initial-infected-value').textContent = "0.01%";
                initialInfected = 0.01;
                
                document.getElementById('immunity-levels').value = 365;
                document.getElementById('immunity-levels-value').textContent = "365";
                m = 365;
                
                document.getElementById('simulation-duration').value = 1500;
                document.getElementById('simulation-duration-value').textContent = "1500";
                simulationDuration = 1500;
                
                document.getElementById('fact').value = 1;
                fact = 1;
                
                // Update results
                calculateAndDisplayResults();
            }
            
            // Enable start button
            document.getElementById('start-btn').disabled = false;
            simulationRunning = false;
        }
    </script>
</body>
</html>